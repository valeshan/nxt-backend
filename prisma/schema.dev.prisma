generator client {
  provider = "prisma-client-js"
}

// Dev-only Prisma schema.
// This is identical to schema.prisma, except it enables a shadow database for migrate dev/reset.
// IMPORTANT: Do NOT use this schema in production.

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Dev-only: required for prisma migrate dev/reset.
  // Production must NOT set SHADOW_DATABASE_URL.
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id                    String             @id @default(uuid())
  email                 String             @unique
  passwordHash          String
  firstName             String             @default("")
  lastName              String             @default("")
  name                  String?
  profilePicture        String?
  tokenVersion          Int                @default(0)
  onboardingCompletedAt DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  memberships           UserOrganisation[]
  settings              UserSettings?
  xeroConnections       XeroConnection[]
}

model Organisation {
  id                     String                  @id @default(uuid())
  name                   String
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  locations              Location[]
  members                UserOrganisation[]
  xeroConnections        XeroConnection[]
  xeroLocationLinks      XeroLocationLink[]
  suppliers              Supplier[]
  xeroInvoices           XeroInvoice[]
  products               Product[]
  xeroSyncRuns           XeroSyncRun[]
  locationAccountConfigs LocationAccountConfig[]
  supplierAliases        SupplierAlias[]
  ocrInvoices            Invoice[]
  emailForwardingVerifications EmailForwardingVerification[]
  
  // Data contribution consent
  dataContributionEnabled   Boolean   @default(true)
  dataContributionUpdatedAt DateTime?
}

model Location {
  id                String                  @id @default(uuid())
  name              String
  organisationId    String
  organisation      Organisation            @relation(fields: [organisationId], references: [id])
  sharedReportEmails String[]                @default([])
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  xeroLocationLinks XeroLocationLink[]
  xeroInvoices      XeroInvoice[]
  accountConfigs    LocationAccountConfig[]
  ocrInvoices       Invoice[]

  // Routing for inbound emails (optional custom alias)
  mailgunAlias String? @unique

  // Email forwarding status
  forwardingStatus     LocationForwardingStatus? @default(NOT_CONFIGURED)
  forwardingVerifiedAt DateTime?
  
  emailForwardingVerifications EmailForwardingVerification[]
  
  // Segmentation for analytics
  industry  VenueIndustry?
  region    String?
}

model LocationAccountConfig {
  id             String       @id @default(uuid())
  organisationId String
  locationId     String
  accountCode    String
  category       String       @default("COGS") // COGS, etc.
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organisation   Organisation @relation(fields: [organisationId], references: [id])
  location       Location     @relation(fields: [locationId], references: [id])

  @@unique([locationId, accountCode])
  @@index([organisationId, locationId])
}

model UserOrganisation {
  id             String           @id @default(uuid())
  userId         String
  organisationId String
  role           OrganisationRole
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  user           User             @relation(fields: [userId], references: [id])
  organisation   Organisation     @relation(fields: [organisationId], references: [id])

  @@unique([userId, organisationId])
}

model UserSettings {
  id                 String   @id @default(uuid())
  userId             String   @unique
  execDashboard      Boolean  @default(false)
  juniorDashboard    Boolean  @default(false)
  chat               Boolean  @default(false)
  subscriptionPlan   Boolean  @default(false)
  contextAi          Boolean  @default(false)
  liveFeed           Boolean  @default(true)
  playbooks          Boolean  @default(false)
  dashboard          Boolean  @default(true)
  settings           Boolean  @default(true)
  notifications      Boolean  @default(false)
  forecast           Boolean  @default(false)
  productPerformance Boolean  @default(false)
  jacobDashboard     Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id])
}

enum OrganisationRole {
  owner
  admin
  member
}

enum VenueIndustry {
  CAFE
  RESTAURANT
  BAR
  BAKERY
  RETAIL
  HOTEL
  CATERING
  OTHER
}

model XeroConnection {
  id                   String             @id @default(uuid())
  userId               String
  organisationId       String
  xeroTenantId         String             @unique
  tenantName           String
  accessToken          String
  refreshToken         String
  expiresAt            DateTime
  xeroCode             String? // OAuth authorization code used (for audit/debugging)
  xeroState            String? // OAuth state parameter used (for audit/debugging)
  lastSuccessfulSyncAt DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  organisation         Organisation       @relation(fields: [organisationId], references: [id])
  user                 User               @relation(fields: [userId], references: [id])
  locationLinks        XeroLocationLink[]
  syncRuns             XeroSyncRun[]
}

model XeroLocationLink {
  id               String         @id @default(uuid())
  xeroConnectionId String
  organisationId   String
  locationId       String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  xeroConnection   XeroConnection @relation(fields: [xeroConnectionId], references: [id])
  organisation     Organisation   @relation(fields: [organisationId], references: [id])
  location         Location       @relation(fields: [locationId], references: [id])
}

model OnboardingSession {
  id               String         @id @default(uuid())
  mode             OnboardingMode
  email            String?
  organisationId   String?
  locationId       String?
  xeroConnectionId String?
  createdAt        DateTime       @default(now())
  expiresAt        DateTime
  completedAt      DateTime?
}

enum OnboardingMode {
  xero
  manual
}

// Supplier Management Models

model Supplier {
  id             String               @id @default(uuid())
  organisationId String
  name           String
  normalizedName String
  abn            String?
  email          String?
  phone          String?
  website        String?
  country        String?
  city           String?
  sourceType     SupplierSourceType
  status         SupplierStatus       @default(ACTIVE)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  organisation   Organisation         @relation(fields: [organisationId], references: [id])
  invoices       XeroInvoice[]
  sourceLinks    SupplierSourceLink[]
  products       Product[]
  aliases        SupplierAlias[]
  ocrInvoices    Invoice[]

  @@index([organisationId])
  @@index([normalizedName])
}

model SupplierSourceLink {
  id             String               @id @default(uuid())
  supplierId     String
  organisationId String
  sourceSystem   SupplierSourceSystem
  externalId     String? // e.g. Xero ContactID
  rawName        String? // e.g. OCR extracted supplier name
  confidence     Float? // 0-1
  createdAt      DateTime             @default(now())
  supplier       Supplier             @relation(fields: [supplierId], references: [id])

  @@index([organisationId, sourceSystem, externalId])
}

model Product {
  id             String                @id @default(uuid())
  organisationId String
  locationId     String
  supplierId     String?
  productKey     String // normalized stable key (lowercase description/itemCode)
  name           String // human-friendly label
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  organisation   Organisation          @relation(fields: [organisationId], references: [id])
  supplier       Supplier?             @relation(fields: [supplierId], references: [id])
  lineItems      XeroInvoiceLineItem[]

  @@unique([organisationId, locationId, productKey])
  @@index([organisationId, locationId])
}

model XeroInvoice {
  id             String                @id @default(uuid())
  organisationId String
  xeroInvoiceId  String                @unique // Xero InvoiceID
  invoiceNumber  String?
  reference      String?
  type           String? // ACCPAY, etc.
  status         String? // AUTHORISED, PAID, VOIDED
  date           DateTime?
  dueDate        DateTime?
  total          Decimal?              @db.Decimal(19, 4)
  subTotal       Decimal?              @db.Decimal(19, 4)
  taxAmount      Decimal?              @db.Decimal(19, 4)
  amountDue      Decimal?              @db.Decimal(19, 4)
  amountPaid     Decimal?              @db.Decimal(19, 4)
  currencyCode   String?
  updatedDateUTC DateTime?
  supplierId     String?
  supplier       Supplier?             @relation(fields: [supplierId], references: [id])
  organisation   Organisation          @relation(fields: [organisationId], references: [id])
  locationId     String?
  location       Location?             @relation(fields: [locationId], references: [id])
  xeroTenantId   String?
  lineItems      XeroInvoiceLineItem[]
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  deletedAt      DateTime?

  @@index([organisationId])
  @@index([supplierId])
  @@index([organisationId, locationId, date])
}

model XeroInvoiceLineItem {
  id          String      @id @default(uuid())
  invoiceId   String
  description String?
  quantity    Decimal?    @db.Decimal(19, 4)
  unitAmount  Decimal?    @db.Decimal(19, 4)
  lineAmount  Decimal?    @db.Decimal(19, 4)
  taxAmount   Decimal?    @db.Decimal(19, 4)
  itemCode    String?
  accountCode String?
  accountName String?
  productId   String?
  product     Product?    @relation(fields: [productId], references: [id])
  invoice     XeroInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([productId])
}

enum SupplierSourceType {
  XERO
  OCR
  MANUAL
  MERGED
}

enum SupplierStatus {
  ACTIVE
  ARCHIVED
  PENDING_REVIEW
}

enum SupplierSourceSystem {
  XERO
  OCR
  MANUAL
}

enum XeroSyncTriggerType {
  MANUAL
  WEBHOOK
  SYSTEM
}

enum XeroSyncScope {
  INCREMENTAL
  FULL
}

enum XeroSyncStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
}

model XeroSyncRun {
  id               String              @id @default(uuid())
  xeroConnectionId String
  organisationId   String
  tenantId         String?
  triggerType      XeroSyncTriggerType
  scope            XeroSyncScope
  status           XeroSyncStatus
  startedAt        DateTime            @default(now())
  updatedAt        DateTime            @default(now()) @updatedAt
  finishedAt       DateTime?
  errorMessage     String?
  rowsProcessed    Int?
  xeroConnection   XeroConnection      @relation(fields: [xeroConnectionId], references: [id])
  organisation     Organisation        @relation(fields: [organisationId], references: [id])

  @@index([xeroConnectionId, status, startedAt])
}

model XeroAuthSession {
  id             String   @id @default(uuid()) // Acts as OAuth state
  userId         String
  organisationId String
  locationIds    String[]
  createdAt      DateTime @default(now())
  expiresAt      DateTime
}

// Invoice OCR & Ingestion Models

enum InvoiceSourceType {
  UPLOAD
  XERO
  EMAIL
}

enum ProcessingStatus {
  UPLOADING
  PENDING_OCR
  OCR_PROCESSING
  OCR_COMPLETE
  OCR_FAILED
  MANUALLY_UPDATED
}

enum ReviewStatus {
  NONE
  NEEDS_REVIEW
  VERIFIED
}

enum OcrFailureCategory {
  LOW_IMAGE_QUALITY
  BLURRY
  GLARE_OR_SHADOW
  LOW_RESOLUTION
  ROTATION_OR_SKEW
  CROPPED_OR_PARTIAL
  DOCUMENT_TYPE_MISMATCH
  NOT_A_DOCUMENT
  PROVIDER_TIMEOUT
  PROVIDER_ERROR
  UNKNOWN
}

model SupplierAlias {
  id                  String       @id @default(uuid())
  organisationId      String
  supplierId          String
  aliasName           String
  normalisedAliasName String
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  organisation        Organisation @relation(fields: [organisationId], references: [id])
  supplier            Supplier     @relation(fields: [supplierId], references: [id])

  @@unique([organisationId, normalisedAliasName])
  @@index([organisationId])
}

model InvoiceFile {
  id                 String              @id @default(uuid())
  organisationId     String
  locationId         String
  sourceType         InvoiceSourceType
  sourceReference    String? // Xero bill ID, email ID, etc
  storageKey         String // S3 key
  fileName           String
  mimeType           String
  processingStatus   ProcessingStatus
  reviewStatus       ReviewStatus        @default(NONE)
  confidenceScore    Float?
  validationErrors   Json?
  ocrJobId           String? // Textract job reference
  uploadBatchId      String? // Groups files uploaded in same session
  fileSizeBytes      Int? // File size in bytes
  failureReason      String? // Human-readable error message
  ocrAttemptCount    Int                 @default(0)
  ocrFailureCategory OcrFailureCategory?
  ocrFailureDetail   String?
  lastOcrAttemptAt   DateTime?
  preprocessingFlags Json? // Store preprocessing flags like { autoRotate: true, contrastBoost: true }
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  ocrResult          InvoiceOcrResult?
  invoice            Invoice?
  deletedAt          DateTime?

  // Indexes (performance)
  // - Cron cleanup uses processingStatus + updatedAt and filters deletedAt: null in queries.
  @@index([processingStatus, updatedAt])
  // - Common listing scope
  @@index([organisationId, locationId])
  // - Batch upload grouping (used by upload session creation)
  @@index([uploadBatchId])
}

model InvoiceOcrResult {
  id            String      @id @default(uuid())
  invoiceFileId String      @unique
  rawResultJson Json // full Textract or provider output
  parsedJson    Json // normalized schema: header plus line items
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  invoiceFile   InvoiceFile @relation(fields: [invoiceFileId], references: [id])
}

model Invoice {
  id              String            @id @default(uuid())
  organisationId  String
  locationId      String
  invoiceFileId   String?           @unique
  supplierId      String?
  invoiceNumber   String?
  date            DateTime?
  total           Decimal?          @db.Decimal(19, 4)
  tax             Decimal?          @db.Decimal(19, 4)
  subtotal        Decimal?          @db.Decimal(19, 4)
  sourceType      InvoiceSourceType
  sourceReference String?
  isVerified      Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  invoiceFile     InvoiceFile?      @relation(fields: [invoiceFileId], references: [id])
  supplier        Supplier?         @relation(fields: [supplierId], references: [id])
  lineItems       InvoiceLineItem[]
  organisation    Organisation      @relation(fields: [organisationId], references: [id])
  location        Location          @relation(fields: [locationId], references: [id])
  deletedAt       DateTime?

  // Indexes (performance)
  @@index([organisationId, locationId, date])
  @@index([supplierId])
}

model InvoiceLineItem {
  id          String   @id @default(uuid())
  invoiceId   String
  description String
  productCode String?
  quantity    Decimal? @db.Decimal(19, 4)
  unitPrice   Decimal? @db.Decimal(19, 4)
  lineTotal   Decimal? @db.Decimal(19, 4)
  accountCode String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Indexes (performance)
  // Postgres does NOT auto-index foreign keys; add if you query/join by invoiceId frequently.
  @@index([invoiceId])
  // Supplier insights / forecasting often filter by accountCode
  @@index([accountCode])
}

model PriceAlertHistory {
  id             String   @id @default(uuid())
  organisationId String
  supplierId     String
  productId      String
  oldPrice       Decimal  @db.Decimal(19, 4)
  newPrice       Decimal  @db.Decimal(19, 4)
  percentChange  Decimal  @db.Decimal(19, 4)
  sentAt         DateTime @default(now())
  channel        String   @default("EMAIL")
  recipientEmail String

  @@index([organisationId, supplierId, productId, sentAt])
}

// Inbound Email Webhook Models

enum InboundEmailStatus {
  PENDING_FETCH
  QUEUED
  PROCESSING
  PROCESSED
  FAILED_SIGNATURE
  FAILED_ROUTING
  FAILED_FETCH
  FAILED_PROCESSING
}

model InboundEmailEvent {
  id             String             @id @default(uuid())
  recipient      String
  recipientAlias String? // Derived alias (e.g. "cafe-nyc" or uuid)
  sender         String?
  subject        String?
  messageId      String?
  timestamp      String // Raw timestamp from webhook
  token          String // Webhook token
  signature      String // Webhook signature
  status         InboundEmailStatus @default(PENDING_FETCH)
  failureReason  String?
  organisationId String?
  locationId     String?
  raw            Json // Full webhook payload for debugging
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  attachments InboundAttachment[]

  @@unique([token, timestamp])
  @@index([status, createdAt])
  @@index([recipient])
  @@index([recipientAlias])
}

enum InboundAttachmentStatus {
  PENDING
  DOWNLOADING
  UPLOADING
  OCR_STARTED
  SKIPPED_TYPE
  SKIPPED_SIZE
  FAILED
}

model InboundAttachment {
  id                  String                  @id @default(uuid())
  inboundEmailEventId String
  invoiceFileId       String?
  filename            String?
  mimeType            String?
  sizeBytes           Int?
  status              InboundAttachmentStatus @default(PENDING)
  failureReason       String?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt

  inboundEmailEvent InboundEmailEvent @relation(fields: [inboundEmailEventId], references: [id])

  @@index([inboundEmailEventId])
  @@index([status, createdAt])
}

// Email Forwarding Verification Models

enum EmailForwardingVerificationStatus {
  PENDING
  COMPLETED
  EXPIRED
  CANCELLED
}

enum LocationForwardingStatus {
  NOT_CONFIGURED
  PENDING_VERIFICATION
  VERIFIED
}

model EmailForwardingVerification {
  id              String                            @id @default(uuid())
  organisationId  String
  locationId      String
  recipientAlias  String                            // The full inbound address (invoices+{locationId}@...)
  provider        String                            @default("GMAIL") // GMAIL, OUTLOOK, etc.
  status          EmailForwardingVerificationStatus @default(PENDING)
  verificationLink String?                          // The extracted vf- link
  sender          String?                           // For debugging
  subject         String?                           // For debugging
  emailMessageId  String?                           // Mailgun message ID for reference
  expiresAt       DateTime                          // 72 hours from creation
  createdAt       DateTime                          @default(now())
  updatedAt       DateTime                          @updatedAt
  
  organisation    Organisation                      @relation(fields: [organisationId], references: [id])
  location        Location                          @relation(fields: [locationId], references: [id])
  
  @@index([locationId, status])
  @@index([organisationId])
  @@index([expiresAt]) // For cleanup jobs
}

